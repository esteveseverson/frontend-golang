<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas</title>
    <style>
        /* Estilos básicos para layout */
        body {
            font-family: Arial, sans-serif;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table, th, td {
            border: 1px solid black;
        }

        th, td {
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        button {
            margin-right: 5px;
        }

        /* Estilos para o popup */
        #popupOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        #popup {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0px 0px 10px 0px black;
        }

        #popup input {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <h1>Gerenciamento de Notas</h1>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Aluno</th>
                <th>Atividade</th>
                <th>Valor Obtido</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody id="notasTableBody">
            <!-- As linhas das notas serão carregadas aqui -->
        </tbody>
    </table>

    <!-- Popup de Edição -->
    <div id="popupOverlay">
        <div id="popup">
            <form id="formEditarNota">
                <label for="aluno">Aluno:</label>
                <input type="text" id="aluno" readonly>
                <label for="atividade">Atividade:</label>
                <input type="text" id="atividade" readonly>
                <label for="valorObtido">Nova Nota:</label>
                <input type="number" id="valorObtido" required>
                <button type="submit">Salvar</button>
                <button type="button" onclick="fecharPopup()">Cancelar</button>
            </form>
        </div>
    </div>

    <script>
        let notas = [];
        let notaIdGlobal = null;

        // Função para carregar as notas
        function carregarNotas() {
            fetch('http://167.234.254.164:8088/notas')
                .then(response => response.json())
                .then(data => {
                    notas = data; // Armazena as notas globalmente
                    const tbody = document.getElementById('notasTableBody');
                    tbody.innerHTML = '';

                    notas.forEach(nota => {
                        fetch(`http://167.234.254.164:8088/alunos/${nota.aluno_id}`)
                            .then(response => response.json())
                            .then(alunoData => {
                                fetch(`http://167.234.254.164:8088/atividades/${nota.atividade_id}`)
                                    .then(response => response.json())
                                    .then(atividadeData => {
                                        const tr = document.createElement('tr');

                                        const tdId = document.createElement('td');
                                        tdId.textContent = nota.id;
                                        tr.appendChild(tdId);

                                        const tdAluno = document.createElement('td');
                                        tdAluno.textContent = alunoData.nome;
                                        tr.appendChild(tdAluno);

                                        const tdAtividade = document.createElement('td');
                                        tdAtividade.textContent = atividadeData.nome;
                                        tr.appendChild(tdAtividade);

                                        const tdValorObtido = document.createElement('td');
                                        tdValorObtido.textContent = nota.valor_obtido;
                                        tr.appendChild(tdValorObtido);

                                        const tdAcoes = document.createElement('td');
                                        const btnEditar = document.createElement('button');
                                        btnEditar.textContent = 'Editar';
                                        btnEditar.addEventListener('click', () => abrirPopup(nota));
                                        tdAcoes.appendChild(btnEditar);

                                        const btnDeletar = document.createElement('button');
                                        btnDeletar.textContent = 'Deletar';
                                        btnDeletar.addEventListener('click', () => deletarNota(nota.id));
                                        tdAcoes.appendChild(btnDeletar);

                                        tr.appendChild(tdAcoes);

                                        tbody.appendChild(tr);
                                    });
                            });
                    });
                })
                .catch(error => alert('Erro ao carregar as notas.'));
        }

        // Função para abrir o popup de edição de nota
        function abrirPopup(nota) {
            notaIdGlobal = nota.id;

            fetch(`http://167.234.254.164:8088/alunos/${nota.aluno_id}`)
                .then(response => response.json())
                .then(alunoData => {
                    document.getElementById('aluno').value = alunoData.nome;
                });

            fetch(`http://167.234.254.164:8088/atividades/${nota.atividade_id}`)
                .then(response => response.json())
                .then(atividadeData => {
                    document.getElementById('atividade').value = atividadeData.nome;
                });

            document.getElementById('valorObtido').value = nota.valor_obtido;

            document.getElementById('popupOverlay').style.display = 'flex';
        }

        // Função para fechar o popup
        function fecharPopup() {
            notaIdGlobal = null;
            document.getElementById('formEditarNota').reset();
            document.getElementById('popupOverlay').style.display = 'none';
        }

        // Função para atualizar a nota
        document.getElementById('formEditarNota').addEventListener('submit', function(event) {
            event.preventDefault();

            const nota = notas.find(n => n.id === notaIdGlobal);
            const valorObtido = document.getElementById('valorObtido').value;

            const dataAtualizada = {
                ...nota,
                valor_obtido: valorObtido
            };

            fetch(`http://167.234.254.164:8088/notas/${notaIdGlobal}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataAtualizada)
            })
            .then(response => {
                if (response.ok) {
                    fecharPopup();
                    carregarNotas();
                } else {
                    alert('Erro ao atualizar a nota.');
                }
            })
            .catch(error => alert('Erro ao enviar a atualização da nota.'));
        });

        // Função para deletar a nota
        function deletarNota(id) {
            fetch(`http://167.234.254.164:8088/notas/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    carregarNotas();
                } else {
                    alert('Erro ao deletar a nota.');
                }
            })
            .catch(error => alert('Erro ao enviar a solicitação de exclusão da nota.'));
        }

        // Carregar as notas ao carregar a página
        window.onload = carregarNotas;
    </script>

</body>
</html>
